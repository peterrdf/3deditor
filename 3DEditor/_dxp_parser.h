#pragma once


#include <algorithm> 
#include <functional> 
#include <cctype>
#include <locale>

#include <iostream>
#include <fstream>

#include <vector>
#include <string>
#include <map>
#include <set>

using namespace std;

// ------------------------------------------------------------------------------------------------
class _vector3f;

namespace _dxf
{
	// --------------------------------------------------------------------------------------------
	class _parser;	

	// --------------------------------------------------------------------------------------------
	// _error	
	class _error : public runtime_error
	{

	public: // Members		

		// ----------------------------------------------------------------------------------------
		static const string file_not_found;
		static const string invalid_argument;
		static const string sof;
		static const string eof;
		static const string invalid_format;		

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_error(const string& error);
	};
	// _error
	// --------------------------------------------------------------------------------------------	

	// --------------------------------------------------------------------------------------------
	// _reader	
	class _reader
	{

	private: // Members

		// ----------------------------------------------------------------------------------------
		// .dxf file
		ifstream& m_dxfFile;

		// ----------------------------------------------------------------------------------------
		// all rows
		vector<string> m_vecRows;

		// ----------------------------------------------------------------------------------------
		// current row
		size_t m_iRow;

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_reader(ifstream&);

		// ----------------------------------------------------------------------------------------
		virtual ~_reader();		

		// ----------------------------------------------------------------------------------------
		void load();

		// ----------------------------------------------------------------------------------------
		const vector<string>& rows() const;

		// ----------------------------------------------------------------------------------------
		size_t rowIndex() const;

		// ----------------------------------------------------------------------------------------
		const string& row();

		// ----------------------------------------------------------------------------------------
		const string& forth();

		// ----------------------------------------------------------------------------------------
		const string& back();
	};
	// _reader
	// --------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------
	// _group_codes	
	class _group_codes
	{

	public: // Members

		// ----------------------------------------------------------------------------------------
		static const string start;
		static const string name;
		static const string eof;
		static const string section;
		static const string endsec;

		// ----------------------------------------------------------------------------------------
		static const string entities;
		static const string header;
		static const string classes;
		static const string objects;
		static const string tables;
		static const string blocks;
		static const string line;
		static const string arc;
		static const string text;
		static const string mtext;
		static const string viewport;
		static const string vertex;		
		static const string polyline;
		static const string lwpolyline;
		static const string seqend;
		static const string circle;
		static const string block;
		static const string endblock;
		static const string insert;
		static const string table;
		static const string endtable;

		// ----------------------------------------------------------------------------------------
		static const string subclass;
		static const string layer;
		static const string x;
		static const string y;
		static const string z;
		static const string x2;
		static const string y2;
		static const string z2;
		static const string radius;
		static const string extrusion_x;
		static const string extrusion_y;
		static const string extrusion_z;
	};
	// _group_codes
	// --------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------
	// _group
	class _group
	{

	private: // Members

		// ----------------------------------------------------------------------------------------
		string m_strType;

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_group(const string& strType);

		// ----------------------------------------------------------------------------------------
		virtual ~_group();

		// ----------------------------------------------------------------------------------------
		const string& type() const;
	};
	// _group
	// --------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------
	// _entry
	class _entry : public _group
	{

	protected: //  Members

		// ----------------------------------------------------------------------------------------
		_entry* m_pParent;

		// ----------------------------------------------------------------------------------------
		map<string, string> m_mapCode2Value;

		// ----------------------------------------------------------------------------------------
		set<string> m_setMultiValueCodes;

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_entry(const string& strType);

		// ----------------------------------------------------------------------------------------
		virtual ~_entry();

		// ----------------------------------------------------------------------------------------
		void setParent(_entry* pParent);

		// ----------------------------------------------------------------------------------------
		virtual void load(_reader& reader);

		// ----------------------------------------------------------------------------------------
		bool hasValue(const string& strCode);

		// ----------------------------------------------------------------------------------------
		const string& getValue(const string& strCode);

		// ----------------------------------------------------------------------------------------
		void setValue(const string& strCode, const string& strValue);
	};
	// _entry
	// --------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------
	// _entity
	class _entity : public _entry
	{

	protected: //  Members

		// ----------------------------------------------------------------------------------------
		vector<_entity*> m_vecEntities;

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_entity(const string& strType);

		// ----------------------------------------------------------------------------------------
		virtual ~_entity();	

		// ----------------------------------------------------------------------------------------
		virtual int64_t createInstance(_parser* pParser) = 0;
	};
	// _entity
	// --------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------
	// _extrusion
	class _extrusion
	{

	protected: //  Members

		// ----------------------------------------------------------------------------------------
		_entity* m_pEntity;		

		// ----------------------------------------------------------------------------------------
		map<string, string> m_mapMapping;

		// ----------------------------------------------------------------------------------------
		double m_dXFactor;
		double m_dYFactor;
		double m_dZFactor;

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_extrusion(_entity* pEntity);

		// ----------------------------------------------------------------------------------------
		virtual ~_extrusion();

		// ----------------------------------------------------------------------------------------
		double getValue(const string& strCode);

		// ----------------------------------------------------------------------------------------
		double getValue(_entity* pEntity, const string& strCode);

	private: // Methods

		// ----------------------------------------------------------------------------------------
		void initialize();
	};
	// _extrusion
	// --------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------
	// _line	
	class _line : public _entity
	{

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_line();

		// ----------------------------------------------------------------------------------------
		virtual ~_line();

		// ----------------------------------------------------------------------------------------
		virtual int64_t createInstance(_parser* pParser);
	};
	// _line
	// --------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------
	// _arc	
	class _arc : public _entity
	{

	public: // Members
		static const string start_angle;
		static const string end_angle;

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_arc();

		// ----------------------------------------------------------------------------------------
		virtual ~_arc();

		// ----------------------------------------------------------------------------------------
		virtual int64_t createInstance(_parser* pParser);
	};
	// _arc
	// --------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------
	// _text	
	class _text : public _entity
	{

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_text();

		// ----------------------------------------------------------------------------------------
		virtual ~_text();

		// ----------------------------------------------------------------------------------------
		virtual int64_t createInstance(_parser* pParser);
	};
	// _text
	// --------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------
	// _mtext	
	class _mtext : public _entity
	{

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_mtext();

		// ----------------------------------------------------------------------------------------
		virtual ~_mtext();

		// ----------------------------------------------------------------------------------------
		virtual int64_t createInstance(_parser* pParser);
	};
	// _mtext
	// --------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------
	// _viewport	
	class _viewport : public _entity
	{

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_viewport();

		// ----------------------------------------------------------------------------------------
		virtual ~_viewport();

		// ----------------------------------------------------------------------------------------
		virtual int64_t createInstance(_parser* pParser);
	};
	// _viewport
	// --------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------
	// _lwpolyline
	class _lwpolyline : public _entity
	{

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_lwpolyline();

		// ----------------------------------------------------------------------------------------
		virtual ~_lwpolyline();

		// ----------------------------------------------------------------------------------------
		virtual int64_t createInstance(_parser* pParser);
	};
	// _lwpolyline
	// --------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------
	// _vertex
	class _vertex : public _entity
	{	

	public: // Members

		// ----------------------------------------------------------------------------------------
		static const string flag;
		static const string polyface_mesh_vertex1;
		static const string polyface_mesh_vertex2;
		static const string polyface_mesh_vertex3;
		static const string polyface_mesh_vertex4;

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_vertex();

		// ----------------------------------------------------------------------------------------
		virtual ~_vertex();

		// ----------------------------------------------------------------------------------------
		virtual int64_t createInstance(_parser* pParser);
	};
	// _vertex
	// --------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------
	// _circle
	class _circle : public _entity
	{

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_circle();

		// ----------------------------------------------------------------------------------------
		virtual ~_circle();

		// ----------------------------------------------------------------------------------------
		virtual int64_t createInstance(_parser* pParser);
	};
	// _circle
	// --------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------
	// _seqend
	class _seqend : public _entity
	{

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_seqend();

		// ----------------------------------------------------------------------------------------
		virtual ~_seqend();

		// ----------------------------------------------------------------------------------------
		virtual int64_t createInstance(_parser* pParser);
	};
	// _seqend
	// --------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------
	// _polyline
	class _polyline : public _entity
	{

	public: // Members

		// ----------------------------------------------------------------------------------------
		static const string flag;
		static const string m;
		static const string n;

	private: // Members

		// ----------------------------------------------------------------------------------------
		_seqend* m_pSeqend;

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_polyline();

		// ----------------------------------------------------------------------------------------
		virtual ~_polyline();

		// ----------------------------------------------------------------------------------------
		virtual void load(_reader& reader);

		// ----------------------------------------------------------------------------------------
		virtual int64_t createInstance(_parser* pParser);
	};
	// _polyline
	// --------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------
	// _endblk
	class _endblk : public _entry
	{

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_endblk();

		// ----------------------------------------------------------------------------------------
		virtual ~_endblk();
	};
	// _endblk
	// --------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------
	// _block
	class _block : public _entity
	{

	private: // Members

		// ----------------------------------------------------------------------------------------
		int64_t m_iInstance;

		// ----------------------------------------------------------------------------------------
		_endblk* m_pEndblk;

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_block();

		// ----------------------------------------------------------------------------------------
		virtual ~_block();

		// ----------------------------------------------------------------------------------------
		virtual void load(_reader& reader);

		// ----------------------------------------------------------------------------------------
		virtual int64_t createInstance(_parser* pParser);
	};
	// _block
	// --------------------------------------------------------------------------------------------	

	// --------------------------------------------------------------------------------------------
	// _insert
	class _insert : public _entity
	{

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_insert();

		// ----------------------------------------------------------------------------------------
		virtual ~_insert();

		// ----------------------------------------------------------------------------------------
		virtual int64_t createInstance(_parser* pParser);
	};
	// _insert
	// --------------------------------------------------------------------------------------------	

	// --------------------------------------------------------------------------------------------
	// _section
	class _section : public _entry
	{

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_section(const string& strType);

		// ----------------------------------------------------------------------------------------
		virtual ~_section();
	};
	// _section
	// --------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------
	// _entities_section
	class _entities_section : public _section
	{

	private: // Members

		// ----------------------------------------------------------------------------------------
		vector<_entity*> m_vecEntities;

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_entities_section();

		// ----------------------------------------------------------------------------------------
		virtual ~_entities_section();

		// ----------------------------------------------------------------------------------------
		const vector<_entity*>& entities() const;

		// ----------------------------------------------------------------------------------------
		void load(_reader& reader);		
	};
	// _entities_section
	// --------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------
	// _header_section
	class _header_section : public _section
	{

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_header_section();

		// ----------------------------------------------------------------------------------------
		virtual ~_header_section();

		// ----------------------------------------------------------------------------------------
		void load(_reader& reader);
	};
	// _header_section
	// --------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------
	// _classes_section
	class _classes_section : public _section
	{

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_classes_section();

		// ----------------------------------------------------------------------------------------
		virtual ~_classes_section();

		// ----------------------------------------------------------------------------------------
		void load(_reader& reader);
	};
	// _classes_section
	// --------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------
	// _objects_section
	class _objects_section : public _section
	{

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_objects_section();

		// ----------------------------------------------------------------------------------------
		virtual ~_objects_section();

		// ----------------------------------------------------------------------------------------
		void load(_reader& reader);
	};
	// _objects_section
	// --------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------
	// _endtab
	class _endtab : public _entry
	{

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_endtab();

		// ----------------------------------------------------------------------------------------
		virtual ~_endtab();
	};
	// _endtab
	// --------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------
	// _table
	class _table : public _entry
	{

	private: // Members

		vector<_entry*> m_vecEntries;

		// ----------------------------------------------------------------------------------------
		_endtab* m_pEndtab;

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_table();

		// ----------------------------------------------------------------------------------------
		virtual ~_table();

		// ----------------------------------------------------------------------------------------
		virtual void load(_reader& reader);
	};
	// _table
	// --------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------
	// _tables_section
	class _tables_section : public _section
	{

	private: // Members

		vector<_table*> m_vecTables;

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_tables_section();

		// ----------------------------------------------------------------------------------------
		virtual ~_tables_section();

		// ----------------------------------------------------------------------------------------
		void load(_reader& reader);
	};
	// _tables_section
	// --------------------------------------------------------------------------------------------	

	// --------------------------------------------------------------------------------------------
	// _blocks_section
	class _blocks_section : public _section
	{

	private: // Members

		// ----------------------------------------------------------------------------------------
		vector<_block*> m_vecBlocks;

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_blocks_section();

		// ----------------------------------------------------------------------------------------
		virtual ~_blocks_section();

		// ----------------------------------------------------------------------------------------
		const vector<_block*>& blocks();

		// ----------------------------------------------------------------------------------------
		void load(_reader& reader);
	};
	// _blocks_section
	// --------------------------------------------------------------------------------------------	

	// --------------------------------------------------------------------------------------------
	// _parser
	class _parser
	{

	private: // Members

		// ----------------------------------------------------------------------------------------
		int64_t m_iModel;

		// ----------------------------------------------------------------------------------------
		vector<_section*> m_vecSections;

		// ----------------------------------------------------------------------------------------
		map<string, vector<int64_t>> m_mapLayer2Instances;

	public: // Methods

		// ----------------------------------------------------------------------------------------
		_parser(int64_t iModel);

		// ----------------------------------------------------------------------------------------
		virtual ~_parser();

		// ----------------------------------------------------------------------------------------
		int64_t getModel() const;

		// ----------------------------------------------------------------------------------------
		void load(const char* szFile);

		// ----------------------------------------------------------------------------------------
		void onInstanceCreated(_entity* pEntity, int64_t iInstance);

		// ----------------------------------------------------------------------------------------
		static _entity* loadEntity(_reader& reader);

		// ----------------------------------------------------------------------------------------
		_block* findBlockByName(const string& strBlockName);

	private: // Methods

		// ----------------------------------------------------------------------------------------
		void createInstances();
	};
	// _parser
	// --------------------------------------------------------------------------------------------
};

